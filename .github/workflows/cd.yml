name: CD - Publish and Release

# CD Pipeline: Build, package, and create GitHub Release
# Trigger: Git tags (v*.*.*) or manual dispatch
# Output: Release packages (Full, Single-file, ClickOnce)

on:
  push:
    tags:
      - 'v*.*.*'  # Semantic versioning: v1.0.0, v1.2.3, etc.
  workflow_dispatch:  # Manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release?'
        type: boolean
        required: false
        default: true

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'
  RUNTIME: 'win-x64'
  SOLUTION_FILE: 'WinFormsFashionShop.sln'

jobs:
  # Job 1: Validate trigger and extract version
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      is_prerelease: ${{ steps.set_version.outputs.is_prerelease }}
      version_display: ${{ steps.set_version.outputs.version_display }}
    
    steps:
    - name: Extract version from tag or input
      id: set_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="false"
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
          # Check if version contains alpha, beta, rc (prerelease)
          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
        else
          echo "Error: CD workflow should only run on tags or manual dispatch" >&2
          exit 1
        fi
        
        if [ -z "$VERSION" ]; then
          echo "Error: Version cannot be empty" >&2
          exit 1
        fi
        
        # Validate version format (X.Y.Z)
        if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
          echo "Error: Invalid version format. Expected X.Y.Z" >&2
          exit 1
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "version_display=v$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "âœ… Version determined: $VERSION (prerelease: $IS_PRERELEASE)"

  # Job 2: Build and Publish
  publish:
    name: Build and Publish
    runs-on: windows-latest
    needs: version
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for release notes
        
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
      # Fail-fast: Build must succeed
      
    - name: Publish WinForms App (Self-contained)
      run: |
        dotnet publish GUI/GUI.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --output ./publish/GUI `
          --self-contained true `
          --runtime ${{ env.RUNTIME }} `
          -p:PublishSingleFile=false `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:Version=${{ needs.version.outputs.version }}
          
    - name: Publish WinForms App (Single File)
      run: |
        dotnet publish GUI/GUI.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --output ./publish/GUI-SingleFile `
          --self-contained true `
          --runtime ${{ env.RUNTIME }} `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:Version=${{ needs.version.outputs.version }}
          
    - name: Publish API
      run: |
        dotnet publish API/API.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --output ./publish/API `
          --self-contained true `
          --runtime ${{ env.RUNTIME }} `
          -p:Version=${{ needs.version.outputs.version }}
          
    - name: Publish ClickOnce (if MSBuild available)
      run: |
        $version = "${{ needs.version.outputs.version }}"
        $versionParts = $version -split '\.'
        $major = if ($versionParts.Length -gt 0) { $versionParts[0] } else { "1" }
        $minor = if ($versionParts.Length -gt 1) { $versionParts[1] } else { "0" }
        $build = if ($versionParts.Length -gt 2) { $versionParts[2] } else { "0" }
        $revision = if ($versionParts.Length -gt 3) { $versionParts[3] } else { "0" }
        $appVersion = "$major.$minor.$build.$revision"
        
        Write-Host "Publishing ClickOnce with version: $appVersion" -ForegroundColor Cyan
        
        # Update version in .csproj
        $csprojPath = ".\GUI\GUI.csproj"
        $csprojContent = Get-Content $csprojPath -Raw
        $csprojContent = $csprojContent -replace '<ApplicationVersion>.*?</ApplicationVersion>', "<ApplicationVersion>$appVersion</ApplicationVersion>"
        $csprojContent = $csprojContent -replace '<PublishUrl>.*?</PublishUrl>', '<PublishUrl>.\publish\ClickOnce\</PublishUrl>'
        $csprojContent = $csprojContent -replace '<InstallFrom>.*?</InstallFrom>', '<InstallFrom>Disk</InstallFrom>'
        $csprojContent = $csprojContent -replace '<UpdateEnabled>.*?</UpdateEnabled>', '<UpdateEnabled>false</UpdateEnabled>'
        Set-Content -Path $csprojPath -Value $csprojContent -NoNewline
        
        # Try to find MSBuild
        $msbuildPaths = @(
          "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe",
          "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe",
          "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe",
          "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe",
          "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe",
          "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
        )
        
        $msbuildPath = $msbuildPaths | Where-Object { Test-Path $_ } | Select-Object -First 1
        
        if ($msbuildPath) {
          Write-Host "Using MSBuild: $msbuildPath" -ForegroundColor Green
          & $msbuildPath GUI\GUI.csproj `
            /t:Publish `
            /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
            /p:PublishUrl=.\publish\ClickOnce\ `
            /p:ApplicationVersion=$appVersion `
            /p:InstallFrom=Disk `
            /p:UpdateEnabled=false `
            /p:IsWebBootstrapper=false
        } else {
          Write-Host "MSBuild not found. Skipping ClickOnce publish." -ForegroundColor Yellow
        }
      continue-on-error: true
      
    - name: Create release packages
      id: create_packages
      shell: pwsh
      run: |
        $version = "${{ needs.version.outputs.version }}"
        $date = Get-Date -Format "yyyyMMdd"
        $commitHash = "${{ github.sha }}"
        $buildNumber = "${{ github.run_number }}"
        
        # Create version info (avoid heredoc for YAML compatibility)
        $versionInfo = "Version: $version`nBuild Date: $date`nBuild Number: $buildNumber`nCommit: $commitHash`nRuntime: ${{ env.RUNTIME }}`n.NET Version: ${{ env.DOTNET_VERSION }}"
        
        # Package 1: Full Package (Self-contained)
        Write-Host "Creating full package..." -ForegroundColor Cyan
        $packageName = "WinFormsFashionShop-v$version-$date"
        New-Item -ItemType Directory -Path "./release-package" -Force | Out-Null
        Copy-Item -Path "./publish/GUI/*" -Destination "./release-package/" -Recurse -Force
        New-Item -ItemType Directory -Path "./release-package/API" -Force | Out-Null
        Copy-Item -Path "./publish/API/*" -Destination "./release-package/API/" -Recurse -Force
        Copy-Item -Path "./Database/CreateDatabase.sql" -Destination "./release-package/" -Force
        Copy-Item -Path "./README.md" -Destination "./release-package/" -Force
        $versionInfo | Out-File -FilePath "./release-package/VERSION.txt" -Encoding UTF8
        Compress-Archive -Path "./release-package/*" -DestinationPath "./$packageName.zip" -Force
        echo "package_full=$packageName.zip" >> $env:GITHUB_OUTPUT
        
        # Package 2: Single File Package
        Write-Host "Creating single-file package..." -ForegroundColor Cyan
        $singlePackageName = "$packageName-singlefile"
        New-Item -ItemType Directory -Path "./release-package-single" -Force | Out-Null
        Copy-Item -Path "./publish/GUI-SingleFile/GUI.exe" -Destination "./release-package-single/" -Force
        Copy-Item -Path "./Database/CreateDatabase.sql" -Destination "./release-package-single/" -Force
        Copy-Item -Path "./README.md" -Destination "./release-package-single/" -Force
        $versionInfo | Out-File -FilePath "./release-package-single/VERSION.txt" -Encoding UTF8
        Compress-Archive -Path "./release-package-single/*" -DestinationPath "./$singlePackageName.zip" -Force
        echo "package_single=$singlePackageName.zip" >> $env:GITHUB_OUTPUT
        
        # Package 3: ClickOnce Package (if available)
        if (Test-Path "./publish/ClickOnce/setup.exe") {
          Write-Host "Creating ClickOnce package..." -ForegroundColor Cyan
          $clickOncePackageName = "$packageName-ClickOnce"
          New-Item -ItemType Directory -Path "./release-package-clickonce" -Force | Out-Null
          Copy-Item -Path "./publish/ClickOnce/setup.exe" -Destination "./release-package-clickonce/" -Force
          Copy-Item -Path "./publish/ClickOnce/GUI.application" -Destination "./release-package-clickonce/" -Force
          if (Test-Path "./publish/ClickOnce/Application Files") {
            Copy-Item -Path "./publish/ClickOnce/Application Files" -Destination "./release-package-clickonce/" -Recurse -Force
          }
          Copy-Item -Path "./Database/CreateDatabase.sql" -Destination "./release-package-clickonce/" -Force
          Copy-Item -Path "./README.md" -Destination "./release-package-clickonce/" -Force
          $versionInfo | Out-File -FilePath "./release-package-clickonce/VERSION.txt" -Encoding UTF8
          Compress-Archive -Path "./release-package-clickonce/*" -DestinationPath "./$clickOncePackageName.zip" -Force
          echo "package_clickonce=$clickOncePackageName.zip" >> $env:GITHUB_OUTPUT
        }
        
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-packages-v${{ needs.version.outputs.version }}
        path: |
          ${{ steps.create_packages.outputs.package_full }}
          ${{ steps.create_packages.outputs.package_single }}
          ${{ steps.create_packages.outputs.package_clickonce }}
        if-no-files-found: error
        retention-days: 30

  # Job 3: Create GitHub Release
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version, publish]
    if: |
      (startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true') &&
      needs.version.outputs.is_prerelease == 'false'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-packages-v${{ needs.version.outputs.version }}
        path: ./artifacts
        
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        DATE=$(date +"%Y-%m-%d")
        COMMIT_HASH="${{ github.sha }}"
        BUILD_NUMBER="${{ github.run_number }}"
        
        NOTES=$(cat <<EOF
        ## WinForms Fashion Shop Management System ${{ needs.version.outputs.version_display }}
        
        **Release Date:** ${DATE}  
        **Build Number:** ${BUILD_NUMBER}  
        **Commit:** \`${COMMIT_HASH:0:7}\`
        
        ### ðŸ“¦ Installation
        
        1. Download and extract the appropriate package
        2. Run \`CreateDatabase.sql\` on your SQL Server
        3. Update \`DatabaseConfig.cs\` with your connection string
        4. Run \`GUI.exe\` to start the application
        
        ### ðŸ“‹ Packages Included
        
        - **Full Package** (\`*-*.zip\`): Complete application with all dependencies (recommended)
        - **Single File** (\`*-singlefile.zip\`): Single executable file (smaller, faster startup)
        - **ClickOnce** (\`*-ClickOnce.zip\`): ClickOnce installer with auto-update support
        
        ### ðŸ”§ Configuration
        
        See \`README.md\` for detailed setup instructions.
        
        ### ðŸ“ Changelog
        
        See commit history for detailed changes.
        EOF
        )
        
        echo "$NOTES" > release_notes.md
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/*.zip
        name: Release ${{ needs.version.outputs.version_display }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ needs.version.outputs.is_prerelease }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

