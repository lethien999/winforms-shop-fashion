name: CD - Publish and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v1.2.3
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release?'
        type: boolean
        required: false
        default: true

# Only run on tag pushes or manual dispatch
# This prevents the workflow from running on regular code pushes

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'
  RUNTIME: 'win-x64'

jobs:
  # Job 1: Check trigger (prevent running on non-tag pushes)
  check-trigger:
    name: Check Trigger
    runs-on: ubuntu-latest
    # Only run if this is a tag push or manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Validate trigger
        id: check
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Base ref: ${{ github.base_ref }}"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "âœ… Manual trigger detected"
            echo "should-run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "âœ… Tag push detected: ${{ github.ref }}"
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Invalid trigger - CD workflow should only run on tags or manual dispatch"
            echo "Current event: ${{ github.event_name }}"
            echo "Current ref: ${{ github.ref }}"
            echo "should-run=false" >> $GITHUB_OUTPUT
            # Don't exit 1 here, just set should-run=false so other jobs skip
          fi
          
          echo "Workflow will proceed with should-run=${{ steps.check.outputs.should-run }}"

  # Job 2: Determine version
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should-run == 'true'
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      is_prerelease: ${{ steps.set_version.outputs.is_prerelease }}
    
    steps:
    - name: Set version from tag or input
      id: set_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="false"
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Extract version from tag (remove 'refs/tags/v' prefix)
          VERSION="${GITHUB_REF#refs/tags/v}"
          # Check if version contains alpha, beta, rc (prerelease)
          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
        else
          echo "Error: CD workflow should only run on tags or manual dispatch" >&2
          exit 1
        fi
        
        if [ -z "$VERSION" ]; then
          echo "Error: Version cannot be empty" >&2
          exit 1
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Determined version: $VERSION (prerelease: $IS_PRERELEASE)"

  # Job 3: Build and Publish
  publish:
    name: Build and Publish
    runs-on: windows-latest
    needs: [check-trigger, version]
    if: needs.check-trigger.outputs.should-run == 'true'
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for release notes
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
      
    - name: Publish WinForms App (Self-contained)
      run: |
        dotnet publish GUI/GUI.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --output ./publish/GUI `
          --self-contained true `
          --runtime ${{ env.RUNTIME }} `
          -p:PublishSingleFile=false `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:Version=${{ needs.version.outputs.version }}
          
    - name: Publish WinForms App (Single File)
      run: |
        dotnet publish GUI/GUI.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --output ./publish/GUI-SingleFile `
          --self-contained true `
          --runtime ${{ env.RUNTIME }} `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:Version=${{ needs.version.outputs.version }}
          
    - name: Publish API
      run: |
        dotnet publish API/API.csproj `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --output ./publish/API `
          --self-contained true `
          --runtime ${{ env.RUNTIME }} `
          -p:Version=${{ needs.version.outputs.version }}
          
    - name: Publish ClickOnce
      run: |
        $version = "${{ needs.version.outputs.version }}"
        $versionParts = $version -split '\.'
        $major = if ($versionParts.Length -gt 0) { $versionParts[0] } else { "1" }
        $minor = if ($versionParts.Length -gt 1) { $versionParts[1] } else { "0" }
        $build = if ($versionParts.Length -gt 2) { $versionParts[2] } else { "0" }
        $revision = if ($versionParts.Length -gt 3) { $versionParts[3] } else { "0" }
        $appVersion = "$major.$minor.$build.$revision"
        
        Write-Host "Publishing ClickOnce with version: $appVersion" -ForegroundColor Cyan
        
        # Update version in .csproj
        $csprojPath = ".\GUI\GUI.csproj"
        $csprojContent = Get-Content $csprojPath -Raw
        
        # Update ApplicationVersion
        $csprojContent = $csprojContent -replace '<ApplicationVersion>.*?</ApplicationVersion>', "<ApplicationVersion>$appVersion</ApplicationVersion>"
        
        # Update PublishUrl
        $csprojContent = $csprojContent -replace '<PublishUrl>.*?</PublishUrl>', '<PublishUrl>.\publish\ClickOnce\</PublishUrl>'
        
        # Set InstallFrom to Disk
        $csprojContent = $csprojContent -replace '<InstallFrom>.*?</InstallFrom>', '<InstallFrom>Disk</InstallFrom>'
        
        # Disable updates for ClickOnce (since we're packaging for download)
        $csprojContent = $csprojContent -replace '<UpdateEnabled>.*?</UpdateEnabled>', '<UpdateEnabled>false</UpdateEnabled>'
        
        Set-Content -Path $csprojPath -Value $csprojContent -NoNewline
        
        # Publish using MSBuild
        $msbuildPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
        if (-not (Test-Path $msbuildPath)) {
          $msbuildPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe"
        }
        if (-not (Test-Path $msbuildPath)) {
          $msbuildPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
        }
        if (-not (Test-Path $msbuildPath)) {
          $msbuildPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
        }
        if (-not (Test-Path $msbuildPath)) {
          $msbuildPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe"
        }
        if (-not (Test-Path $msbuildPath)) {
          $msbuildPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
        }
        
        if (Test-Path $msbuildPath) {
          Write-Host "Using MSBuild: $msbuildPath" -ForegroundColor Green
          & $msbuildPath GUI\GUI.csproj `
            /t:Publish `
            /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
            /p:PublishUrl=.\publish\ClickOnce\ `
            /p:ApplicationVersion=$appVersion `
            /p:InstallFrom=Disk `
            /p:UpdateEnabled=false `
            /p:IsWebBootstrapper=false
        } else {
          Write-Host "MSBuild not found. Skipping ClickOnce publish." -ForegroundColor Yellow
          Write-Host "Note: ClickOnce requires Visual Studio MSBuild." -ForegroundColor Yellow
        }
      continue-on-error: true
          
    - name: Get file sizes
      run: |
        Write-Host "=== Published File Sizes ===" -ForegroundColor Cyan
        Get-ChildItem -Path "./publish" -Recurse -File | 
          Sort-Object Length -Descending | 
          Select-Object -First 10 FullName, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB, 2)}} | 
          Format-Table -AutoSize
        
        $totalSize = (Get-ChildItem -Path "./publish" -Recurse -File | Measure-Object -Property Length -Sum).Sum
        Write-Host "Total size: $([math]::Round($totalSize/1MB, 2)) MB" -ForegroundColor Green
        
    - name: Create release package
      run: |
        $version = "${{ needs.version.outputs.version }}"
        $date = Get-Date -Format "yyyyMMdd"
        $packageName = "WinFormsFashionShop-v$version-$date"
        
        # Create package directory
        New-Item -ItemType Directory -Path "./release-package" -Force | Out-Null
        
        # Copy GUI files (self-contained version)
        Copy-Item -Path "./publish/GUI/*" -Destination "./release-package/" -Recurse -Force
        
        # Copy API files to separate folder
        New-Item -ItemType Directory -Path "./release-package/API" -Force | Out-Null
        Copy-Item -Path "./publish/API/*" -Destination "./release-package/API/" -Recurse -Force
        
        # Copy database script
        Copy-Item -Path "./Database/CreateDatabase.sql" -Destination "./release-package/" -Force
        
        # Copy documentation
        Copy-Item -Path "./README.md" -Destination "./release-package/" -Force
        if (Test-Path "./PUBLISH_GUIDE.md") {
          Copy-Item -Path "./PUBLISH_GUIDE.md" -Destination "./release-package/" -Force
        }
        
        # Create version file
        $versionInfo = @"
Version: $version
Build Date: $date
Build Number: ${{ github.run_number }}
Commit: ${{ github.sha }}
Runtime: ${{ env.RUNTIME }}
.NET Version: ${{ env.DOTNET_VERSION }}
"@
        $versionInfo | Out-File -FilePath "./release-package/VERSION.txt" -Encoding UTF8
        
        # Create zip package
        Compress-Archive -Path "./release-package/*" -DestinationPath "./$packageName.zip" -Force
        
        # Also create single-file version package
        New-Item -ItemType Directory -Path "./release-package-single" -Force | Out-Null
        Copy-Item -Path "./publish/GUI-SingleFile/GUI.exe" -Destination "./release-package-single/" -Force
        Copy-Item -Path "./Database/CreateDatabase.sql" -Destination "./release-package-single/" -Force
        Copy-Item -Path "./README.md" -Destination "./release-package-single/" -Force
        $versionInfo | Out-File -FilePath "./release-package-single/VERSION.txt" -Encoding UTF8
        Compress-Archive -Path "./release-package-single/*" -DestinationPath "./$packageName-singlefile.zip" -Force
        
        # Create ClickOnce package (if available)
        if (Test-Path "./publish/ClickOnce/setup.exe") {
          Write-Host "Creating ClickOnce package..." -ForegroundColor Cyan
          $clickOncePackageName = "WinFormsFashionShop-v$version-ClickOnce-$date"
          New-Item -ItemType Directory -Path "./release-package-clickonce" -Force | Out-Null
          
          # Copy ClickOnce files
          Copy-Item -Path "./publish/ClickOnce/setup.exe" -Destination "./release-package-clickonce/" -Force
          Copy-Item -Path "./publish/ClickOnce/GUI.application" -Destination "./release-package-clickonce/" -Force
          if (Test-Path "./publish/ClickOnce/Application Files") {
            Copy-Item -Path "./publish/ClickOnce/Application Files" -Destination "./release-package-clickonce/" -Recurse -Force
          }
          
          # Copy database script and docs
          Copy-Item -Path "./Database/CreateDatabase.sql" -Destination "./release-package-clickonce/" -Force
          Copy-Item -Path "./README.md" -Destination "./release-package-clickonce/" -Force
          $versionInfo | Out-File -FilePath "./release-package-clickonce/VERSION.txt" -Encoding UTF8
          
          # Create zip
          Compress-Archive -Path "./release-package-clickonce/*" -DestinationPath "./$clickOncePackageName.zip" -Force
          echo "PACKAGE_CLICKONCE=$clickOncePackageName.zip" >> $env:GITHUB_ENV
          Write-Host "ClickOnce package created: $clickOncePackageName.zip" -ForegroundColor Green
        } else {
          Write-Host "ClickOnce files not found. Skipping ClickOnce package." -ForegroundColor Yellow
        }
        
        echo "PACKAGE_NAME=$packageName.zip" >> $env:GITHUB_ENV
        echo "PACKAGE_SINGLE=$packageName-singlefile.zip" >> $env:GITHUB_ENV
        
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: winforms-release-v${{ needs.version.outputs.version }}
        path: |
          ${{ env.PACKAGE_NAME }}
          ${{ env.PACKAGE_SINGLE }}
          ${{ env.PACKAGE_CLICKONCE }}
          publish/
        if-no-files-found: warn
        retention-days: 30

  # Job 4: Create GitHub Release
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-trigger, version, publish]
    if: |
      needs.check-trigger.outputs.should-run == 'true' &&
      (startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true') &&
      needs.version.outputs.is_prerelease == 'false'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: winforms-release-v${{ needs.version.outputs.version }}
        path: ./artifacts
        
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        DATE=$(date +"%Y-%m-%d")
        
        NOTES=$(cat <<EOF
        ## WinForms Fashion Shop Management System v${VERSION}
        
        **Release Date:** ${DATE}
        **Build Number:** ${{ github.run_number }}
        
        ### ðŸ“¦ Installation
        
        1. Download and extract the zip file
        2. Run \`CreateDatabase.sql\` on your SQL Server
        3. Update \`DatabaseConfig.cs\` with your connection string
        4. Run \`GUI.exe\` to start the application
        
        ### ðŸ“‹ What's Included
        
        - **Full Package** (\`WinFormsFashionShop-v${VERSION}-*.zip\`): Complete application with all dependencies
        - **Single File** (\`*-singlefile.zip\`): Single executable file (smaller, faster startup)
        
        ### ðŸ”§ Configuration
        
        See \`README.md\` for detailed setup instructions.
        
        ### ðŸ“ Changes
        
        See commit history for detailed changes.
        EOF
        )
        
        echo "$NOTES" > release_notes.md
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: List artifacts before release
      run: |
        echo "=== Artifacts directory ==="
        ls -la ./artifacts/ || echo "Artifacts directory not found"
        echo ""
        echo "=== ZIP files ==="
        find ./artifacts -name "*.zip" -type f || echo "No ZIP files found"
        
    - name: List release files
      run: |
        Write-Host "=== Release Files ===" -ForegroundColor Cyan
        Get-ChildItem -Path "./artifacts" -Filter "*.zip" -ErrorAction SilentlyContinue | 
          ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)" }
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*.zip
        name: Release v${{ needs.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ needs.version.outputs.is_prerelease }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
